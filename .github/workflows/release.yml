name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¸ç™¼æ¢ä»¶ï¼šæ¨é€ v é–‹é ­çš„ tagï¼Œä¾‹å¦‚ v1.24.1225143000

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_NAME: L1MapViewer

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        # å¾ tag å–å¾—ç‰ˆæœ¬è™Ÿ (ç§»é™¤ 'v' å‰ç¶´)
        # Tag æ ¼å¼: v1.yy.MMddHHmm (ä¾‹å¦‚ v1.24.1225143000)
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG=$TAG" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: |
        dotnet build --configuration Release --no-restore /p:Version=${{ steps.get_version.outputs.VERSION }}

    - name: Publish (Self-contained)
      run: |
        dotnet publish --configuration Release --runtime win-x64 --self-contained true -o publish/self-contained /p:Version=${{ steps.get_version.outputs.VERSION }} /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

    - name: Publish (Framework-dependent)
      run: |
        dotnet publish --configuration Release -o publish/framework-dependent /p:Version=${{ steps.get_version.outputs.VERSION }}

    - name: Create ZIP archives
      shell: pwsh
      run: |
        # Self-contained ç‰ˆæœ¬ (åŒ…å« .NET Runtime)
        Compress-Archive -Path "publish/self-contained/*" -DestinationPath "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64-self-contained.zip"

        # Framework-dependent ç‰ˆæœ¬ (éœ€è¦å®‰è£ .NET Runtime)
        Compress-Archive -Path "publish/framework-dependent/*" -DestinationPath "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}
        body: |
          ## ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}

          ### Downloads
          - **Self-contained** (`-self-contained.zip`): åŒ…å« .NET Runtimeï¼Œå¯ç›´æ¥åŸ·è¡Œ
          - **Framework-dependent** (`.zip`): éœ€è¦å®‰è£ [.NET 10 Runtime](https://dotnet.microsoft.com/download/dotnet/10.0)

          ### Changes
          See [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }}) for details.
        files: |
          ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64-self-contained.zip
          ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.TAG, '-') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Discord Release Notification (Release Channel)
      if: success()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_RELEASE }}
        nodetail: true
        title: "ğŸ‰ æ–°ç‰ˆæœ¬ç™¼å¸ƒ: ${{ steps.get_version.outputs.TAG }}"
        description: |
          **${{ env.PROJECT_NAME }}** å·²ç™¼å¸ƒæ–°ç‰ˆæœ¬ï¼

          ğŸ“¦ [ä¸‹è¼‰é€£çµ](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }})
          ğŸ“ [è®Šæ›´ç´€éŒ„](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }})
        color: 0x00ff00

    - name: Discord Release Notification (Dev Channel)
      if: success()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_DEV }}
        nodetail: true
        title: "ğŸ‰ æ–°ç‰ˆæœ¬ç™¼å¸ƒ: ${{ steps.get_version.outputs.TAG }}"
        description: |
          **${{ env.PROJECT_NAME }}** å·²ç™¼å¸ƒæ–°ç‰ˆæœ¬ï¼

          ğŸ“¦ [ä¸‹è¼‰é€£çµ](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }})
          ğŸ“ [è®Šæ›´ç´€éŒ„](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }})
        color: 0x00ff00
